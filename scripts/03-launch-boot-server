#!/bin/bash

set -Eeuo pipefail

cd "${0%/*}"
. ./functions.sh
read_config

info "###########################"
info "# BOOT SERVER PREPARATION #"
info "###########################"

cd ..
if [ ! -d "data" ]; then
	mkdir "data"
fi
cd "data"

HOST_NAME="boot"
QEMU_IMG="${HOST_NAME}.img"
QEMU_EXTRA_OPTS="-name ${HOST_NAME} -drive file=${QEMU_IMG},format=qcow2,cache=unsafe,if=virtio,aio=io_uring -device virtio-net,netdev=network0,mac=52:54:00:00:00:01 -netdev tap,id=network0,ifname=tap1,script=no,downscript=no"

FRESH_INSTALL=0

if [ ! -e "${QEMU_IMG}" ]; then
	FRESH_INSTALL=1
	qemu-img create -f qcow2 "${QEMU_IMG}" "${DL_QEMU_DISK_SIZE}"
	gnome-terminal --tab --wait --title "${HOST_NAME}-install" --		\
		qemu-system-x86_64						\
		${DL_QEMU_OPTS}							\
		$QEMU_EXTRA_OPTS						\
		-kernel ../tmp/linux						\
		-initrd ../tmp/initrd-mod.gz					\
		-append "quiet DEBIAN_FRONTEND=text console=ttyS0,115200,n8 auto=true priority=critical netcfg/disable_autoconfig=true netcfg/get_ipaddress=192.168.99.1 netcfg/get_netmask=255.255.255.0 netcfg/get_gateway=${DL_BRIDGE_ADDRESS} netcfg/get_nameservers=${DL_NAMESERVER} hostname=${HOST_NAME} domain=${DL_DOMAIN}"
fi

exit 0
